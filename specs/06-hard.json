{
  "meta": {
    "name": "06-hard",
    "version": "1.1",
    "defaultOutput": "text",
    "description": "Challenge 06."
  },
  "initialState": {
    "region": "",
    "env": {},
    "identities": [
      {
        "id": "cloudops.hana.yamamoto",
        "accountId": "555555555555",
        "arn": "arn:aws:iam::555555555555:user/cloudops.hana.yamamoto",
        "userName": "cloudops.hana.yamamoto",
        "policies": [
          "ssm:DescribeParameters",
          "ecs:ListClusters",
          "ecs:ListTasks",
          "ecs:DescribeTasks",
          "iam:GetRole",
          "iam:ListRolePolicies",
          "iam:GetRolePolicy"
        ]
      },
      {
        "id": "ecsmeta-task-role",
        "accountId": "555555555555",
        "arn": "arn:aws:iam::555555555555:role/ecsmeta-task-role",
        "userName": "ecsmeta-task-role",
        "policies": [
          "ssm:DescribeParameters",
          "ssm:GetParameter"
        ]
      }
    ],
    "activeIdentity": "cloudops.hana.yamamoto",
    "custom": {
      "flag": "flag{ecs-metadata-to-ssm-123}",
      "paramName": "/prod/ecsmeta/app/flag",
      "clusterName": "ecsmeta-frontend-prod",
      "taskArn": "arn:aws:ecs:us-east-1:555555555555:task/ecsmeta-frontend-prod/1a2b3c4d5e6f7890abcdef1234567890",
      "taskDefinition": "arn:aws:ecs:us-east-1:555555555555:task-definition/ecsmeta-frontend:42"
    }
  },
  "commands": [
    {
      "match": {
        "equals": "aws sts get-caller-identity"
      },
      "response": {
        "render": "json",
        "json": {
          "UserId": "AIDACTFECSMETA01",
          "Account": "555555555555",
          "Arn": "arn:aws:iam::555555555555:user/cloudops.hana.yamamoto"
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+configure\\s+set\\s+region\\s+us-east-1$"
      },
      "mutateState": [
        {
          "op": "set",
          "path": "region",
          "value": "us-east-1"
        }
      ],
      "response": {
        "text": ""
      }
    },
    {
      "match": {
        "regex": "^export\\s+AWS_DEFAULT_REGION=us-east-1$"
      },
      "mutateState": [
        {
          "op": "set",
          "path": "env.AWS_DEFAULT_REGION",
          "value": "us-east-1"
        },
        {
          "op": "set",
          "path": "region",
          "value": "us-east-1"
        }
      ],
      "response": {
        "text": ""
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-role\\s+--role-name\\s+ecsmeta-task-role\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "Role": {
            "RoleName": "ecsmeta-task-role",
            "Arn": "arn:aws:iam::555555555555:role/ecsmeta-task-role",
            "CreateDate": "2025-10-04T00:00:00+00:00"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+list-role-policies\\s+--role-name\\s+ecsmeta-task-role\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "PolicyNames": [
            "ecsmeta-task-diagnostics"
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-role-policy\\s+--role-name\\s+ecsmeta-task-role\\s+--policy-name\\s+ecsmeta-task-diagnostics\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "Policy": {
            "RoleName": "ecsmeta-task-role",
            "PolicyName": "ecsmeta-task-diagnostics",
            "PolicyDocument": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowDiagnosticsParameters\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\"ssm:DescribeParameters\", \"ssm:GetParameter\"],\n      \"Resource\": \"*\"\n    }\n  ]\n}"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws ecs list-clusters$"
      },
      "requires": {
        "hasPoliciesAny": [
          "ecs:ListClusters"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "clusterArns": [
            "arn:aws:ecs:us-east-1:555555555555:cluster/{{custom.clusterName}}",
            "arn:aws:ecs:us-east-1:555555555555:cluster/ecsmeta-training-sandbox"
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDeniedException) when calling the ListClusters operation: User is not authorized to perform ecs:ListClusters",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws ecs list-tasks --cluster ecsmeta-frontend-prod --desired-status RUNNING$"
      },
      "requires": {
        "hasPoliciesAny": [
          "ecs:ListTasks"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "taskArns": [
            "{{custom.taskArn}}"
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDeniedException) when calling the ListTasks operation: User is not authorized to perform ecs:ListTasks",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws ecs describe-tasks --cluster ecsmeta-frontend-prod --tasks arn:aws:ecs:us-east-1:[0-9]{12}:task/ecsmeta-frontend-prod/[A-Za-z0-9-]+$"
      },
      "requires": {
        "hasPoliciesAny": [
          "ecs:DescribeTasks"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "tasks": [
            {
              "taskArn": "{{custom.taskArn}}",
              "clusterArn": "arn:aws:ecs:us-east-1:555555555555:cluster/{{custom.clusterName}}",
              "taskDefinitionArn": "{{custom.taskDefinition}}",
              "lastStatus": "RUNNING",
              "desiredStatus": "RUNNING",
              "launchType": "FARGATE",
              "cpu": "256",
              "memory": "512",
              "startedBy": "ecs-svc/55555555555567890",
              "tags": [
                {
                  "key": "Service",
                  "value": "ecsmeta-frontend"
                },
                {
                  "key": "Environment",
                  "value": "production"
                }
              ],
              "attachments": [
                {
                  "type": "ElasticNetworkInterface",
                  "id": "eni-0abcde123456789f0",
                  "status": "ATTACHED",
                  "details": [
                    {
                      "name": "subnetId",
                      "value": "subnet-0a1b2c3d4e"
                    },
                    {
                      "name": "networkInterfaceId",
                      "value": "eni-0abcde123456789f0"
                    },
                    {
                      "name": "privateIPv4Address",
                      "value": "10.0.13.24"
                    }
                  ]
                }
              ],
              "containers": [
                {
                  "name": "ecsmeta-frontend",
                  "image": "555555555555.dkr.ecr.us-east-1.amazonaws.com/ecsmeta-frontend:2025-10-03",
                  "runtimeId": "0f1e2d3c4b5a69788776655443322110-1234567890",
                  "lastStatus": "RUNNING",
                  "networkInterfaces": [
                    {
                      "privateIpv4Address": "10.0.13.24"
                    }
                  ]
                }
              ],
              "createdAt": "2025-10-04T00:00:00+00:00"
            }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDeniedException) when calling the DescribeTasks operation: User is not authorized to perform ecs:DescribeTasks",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws\\s+ssm\\s+describe-parameters\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "ssm:DescribeParameters"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "Parameters": [
            {
              "Name": "/prod/ecsmeta/app/flag",
              "Type": "SecureString",
              "Version": 3,
              "LastModifiedDate": "2025-10-04T00:00:00+00:00"
            },
            {
              "Name": "/prod/ecsmeta/app/flag-old",
              "Type": "SecureString",
              "Version": 1,
              "LastModifiedDate": "2025-09-20T00:00:00+00:00"
            }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "UnknownOperation",
        "message": "You must specify a region. You can also configure your region by running 'aws configure'.",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws\\s+ssm\\s+get-parameter\\s+--name\\s+(.+?)\\s+--with-decryption\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "ssm:GetParameter"
        ],
        "activeIdentity": "ecsmeta-task-role"
      },
      "response": {
        "render": "json",
        "json": {
          "Parameter": {
            "Name": "/prod/ecsmeta/app/flag",
            "Type": "SecureString",
            "Value": "flag{ecs-metadata-to-ssm-123}",
            "Version": 3,
            "LastModifiedDate": "2025-10-04T00:00:00+00:00"
          }
        }
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDeniedException) when calling the GetParameter operation: User is not authorized to perform: ssm:GetParameter on resource",
        "exitCode": 255
      }
    }
  ],
  "fallbackError": {
    "errorCode": "UnknownOperation",
    "message": "An error occurred. See 'aws --help'.",
    "exitCode": 255
  }
}
