{
  "meta": {
    "name": "03-medium",
    "version": "1.1",
    "defaultOutput": "text",
    "description": "Challenge 03."
  },
  "initialState": {
    "region": "",
    "env": {},
    "identities": [
      {
        "id": "dataops.mika.shirai",
        "accountId": "444444444444",
        "arn": "arn:aws:iam::444444444444:user/dataops.mika.shirai",
        "userName": "dataops.mika.shirai",
        "policies": [
          "rds:DescribeDBSnapshots",
          "rds:ListTagsForResource",
          "rds:DescribeDBSnapshotAttributes",
          "ec2:DescribeSecurityGroups",
          "iam:GetUser",
          "iam:ListUserPolicies",
          "iam:GetUserPolicy"
        ]
      }
    ],
    "activeIdentity": "dataops.mika.shirai",
    "custom": {
      "accountId": "444444444444",
      "region": "us-east-1",
      "publicSnapshotId": "rdsnap-appdb-20251001",
      "publicSnapshotArn": "arn:aws:rds:us-east-1:444444444444:snapshot:rdsnap-appdb-20251001",
      "decoySnapshotId": "rdsnap-marketing-20250920",
      "auditSecurityGroupId": "sg-0rdsnap123abc",
      "auditSecurityGroupName": "rdsnap-audit-sg",
      "flag": "flag{rds-public-snapshot-123}"
    }
  },
  "commands": [
    {
      "match": {
        "equals": "aws sts get-caller-identity"
      },
      "response": {
        "render": "json",
        "json": {
          "UserId": "AIDACTFRDSNAP01",
          "Account": "444444444444",
          "Arn": "arn:aws:iam::444444444444:user/dataops.mika.shirai"
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+configure\\s+set\\s+region\\s+us-east-1$"
      },
      "mutateState": [
        {
          "op": "set",
          "path": "region",
          "value": "us-east-1"
        }
      ],
      "response": {
        "text": ""
      }
    },
    {
      "match": {
        "regex": "^export\\s+AWS_DEFAULT_REGION=us-east-1$"
      },
      "mutateState": [
        {
          "op": "set",
          "path": "env.AWS_DEFAULT_REGION",
          "value": "us-east-1"
        },
        {
          "op": "set",
          "path": "region",
          "value": "us-east-1"
        }
      ],
      "response": {
        "text": ""
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-user\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "User": {
            "UserName": "dataops.mika.shirai",
            "Arn": "arn:aws:iam::444444444444:user/dataops.mika.shirai",
            "CreateDate": "2025-10-04T00:00:00+00:00"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+list-user-policies\\s+--user-name\\s+dataops\\\\.mika\\\\.shirai\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "PolicyNames": [
            "rdsnap-inspect-public"
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-user-policy\\s+--user-name\\s+dataops\\\\.mika\\\\.shirai\\s+--policy-name\\s+rdsnap-inspect-public\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "Policy": {
            "UserName": "dataops.mika.shirai",
            "PolicyName": "rdsnap-inspect-public",
            "PolicyDocument": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"InspectSharedSnapshots\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\"rds:DescribeDBSnapshots\", \"rds:ListTagsForResource\"],\n      \"Resource\": \"*\"\n    }\n  ]\n}"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+rds\\s+describe-db-snapshots\\s+--include-public\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "rds:DescribeDBSnapshots"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "DBSnapshots": [
            {
              "DBSnapshotIdentifier": "rdsnap-appdb-20251001",
              "DBInstanceIdentifier": "prod-app-db",
              "SnapshotCreateTime": "2025-10-01T00:00:00+00:00",
              "Engine": "mysql",
              "AllocatedStorage": 20,
              "Status": "available",
              "Port": 3306,
              "AvailabilityZone": "us-east-1a",
              "VpcId": "vpc-0123456789abcdef0",
              "Encrypted": false,
              "StorageType": "gp2",
              "IAMDatabaseAuthenticationEnabled": false,
              "DBSnapshotArn": "arn:aws:rds:us-east-1:444444444444:snapshot:rdsnap-appdb-20251001",
              "SourceRegion": "us-east-1",
              "PercentProgress": 100,
              "SnapshotType": "public"
            },
            {
              "DBSnapshotIdentifier": "rdsnap-marketing-20250920",
              "DBInstanceIdentifier": "reporting-db",
              "SnapshotCreateTime": "2025-10-02T00:00:00+00:00",
              "Engine": "postgres",
              "AllocatedStorage": 10,
              "Status": "available",
              "Port": 5432,
              "AvailabilityZone": "us-east-1b",
              "VpcId": "vpc-0fedcba9876543210",
              "Encrypted": true,
              "KmsKeyId": "arn:aws:kms:us-east-1:444444444444:key/aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee",
              "StorageType": "gp3",
              "IAMDatabaseAuthenticationEnabled": false,
              "DBSnapshotArn": "arn:aws:rds:us-east-1:444444444444:snapshot:rdsnap-marketing-20250920",
              "SourceRegion": "us-east-1",
              "PercentProgress": 100,
              "SnapshotType": "manual"
            }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "UnknownOperation",
        "message": "You must specify a region. You can also configure your region by running 'aws configure'.",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws\\s+rds\\s+describe-db-snapshots\\s+--db-snapshot-identifier\\s+rdsnap\\\\-appdb\\\\-20251001\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "rds:DescribeDBSnapshots"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "DBSnapshots": [
            {
              "DBSnapshotIdentifier": "rdsnap-appdb-20251001",
              "DBInstanceIdentifier": "prod-app-db",
              "SnapshotCreateTime": "2025-10-01T00:00:00+00:00",
              "Engine": "mysql",
              "AllocatedStorage": 20,
              "Status": "available",
              "Port": 3306,
              "AvailabilityZone": "us-east-1a",
              "VpcId": "vpc-0123456789abcdef0",
              "Encrypted": false,
              "StorageType": "gp2",
              "IAMDatabaseAuthenticationEnabled": false,
              "DBSnapshotArn": "arn:aws:rds:us-east-1:444444444444:snapshot:rdsnap-appdb-20251001",
              "SourceRegion": "us-east-1",
              "PercentProgress": 100,
              "SnapshotType": "public"
            }
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+rds\\s+list-tags-for-resource\\s+--resource-name\\s+arn:aws:rds:us-east-1:[0-9]{12}:snapshot:rdsnap\\-appdb\\-20251001\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "rds:ListTagsForResource"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "TagList": [
            {
              "Key": "Name",
              "Value": "public-training-snapshot"
            },
            {
              "Key": "Environment",
              "Value": "demo"
            },
            {
              "Key": "flag",
              "Value": "flag{rds-public-snapshot-123}"
            }
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+rds\\s+list-tags-for-resource\\s+--resource-name\\s+arn:aws:rds:us-east-1:[0-9]{12}:snapshot:rdsnap\\-marketing\\-20250920\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "rds:ListTagsForResource"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "TagList": [
            {
              "Key": "Project",
              "Value": "marketing"
            },
            {
              "Key": "CostCenter",
              "Value": "1234"
            }
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+rds\\s+describe-db-snapshot-attributes\\s+--db-snapshot-identifier\\s+rdsnap\\\\-appdb\\\\-20251001\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "rds:DescribeDBSnapshotAttributes"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "DBSnapshotAttributesResult": {
            "DBSnapshotIdentifier": "rdsnap-appdb-20251001",
            "DBSnapshotAttributes": [
              {
                "AttributeName": "restore",
                "AttributeValues": [
                  "all"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+rds\\s+describe-db-snapshot-attributes\\s+--db-snapshot-identifier\\s+rdsnap\\\\-marketing\\\\-20250920\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "rds:DescribeDBSnapshotAttributes"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "DBSnapshotAttributesResult": {
            "DBSnapshotIdentifier": "rdsnap-marketing-20250920",
            "DBSnapshotAttributes": [
              {
                "AttributeName": "restore",
                "AttributeValues": [
                  "444444444444"
                ]
              }
            ]
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+ec2\\s+describe-security-groups\\s+--group-ids\\s+sg\\\\-0rdsnap123abc\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "ec2:DescribeSecurityGroups"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "SecurityGroups": [
            {
              "GroupId": "sg-0rdsnap123abc",
              "GroupName": "rdsnap-audit-sg",
              "Description": "Shared read access for audit snapshots",
              "VpcId": "vpc-0123456789abcdef0",
              "IpPermissions": [
                {
                  "IpProtocol": "tcp",
                  "FromPort": 3306,
                  "ToPort": 3306,
                  "UserIdGroupPairs": [
                    {
                      "GroupId": "sg-0dbadmins123456789",
                      "GroupName": "db-admins"
                    }
                  ]
                }
              ],
              "IpPermissionsEgress": [
                {
                  "IpProtocol": "-1",
                  "IpRanges": [
                    {
                      "CidrIp": "0.0.0.0/0",
                      "Description": "Audit tooling access"
                    }
                  ]
                }
              ],
              "Tags": [
                {
                  "Key": "Environment",
                  "Value": "demo"
                },
                {
                  "Key": "Purpose",
                  "Value": "snapshot-audit"
                }
              ]
            }
          ]
        }
      }
    }
  ],
  "fallbackError": {
    "errorCode": "UnknownOperation",
    "message": "An error occurred. See 'aws --help'.",
    "exitCode": 255
  }
}
