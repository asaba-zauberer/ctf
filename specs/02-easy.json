{
  "meta": {
    "name": "02-easy",
    "version": "1.1",
    "defaultOutput": "text",
    "description": "Challenge 02."
  },
  "initialState": {
    "region": "",
    "env": {},
    "identities": [
      {
        "id": "messaging.ren.suzuki",
        "accountId": "222222222222",
        "arn": "arn:aws:iam::222222222222:user/messaging.ren.suzuki",
        "userName": "messaging.ren.suzuki",
        "policies": [
          "sqs:ListQueues",
          "sqs:GetQueueAttributes",
          "ec2:DescribeInstances",
          "ec2:DescribeSecurityGroups",
          "iam:GetUser",
          "iam:ListGroupsForUser",
          "iam:GetGroup",
          "iam:ListAttachedGroupPolicies",
          "iam:GetPolicy",
          "iam:GetPolicyVersion"
        ]
      }
    ],
    "activeIdentity": "messaging.ren.suzuki",
    "custom": {
      "accountId": "222222222222",
      "region": "us-east-1",
      "publicQueueName": "sqsopen-notify-dev",
      "privateQueueName": "sqsopen-ledger-dev",
      "flag": "flag{sqs-public-policy-receive-123}"
    }
  },
  "commands": [
    {
      "match": {
        "equals": "aws sts get-caller-identity"
      },
      "response": {
        "render": "json",
        "json": {
          "UserId": "AIDACTFSQSOPEN01",
          "Account": "222222222222",
          "Arn": "arn:aws:iam::222222222222:user/messaging.ren.suzuki"
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+configure\\s+set\\s+region\\s+us-east-1$"
      },
      "mutateState": [
        {
          "op": "set",
          "path": "region",
          "value": "us-east-1"
        }
      ],
      "response": {
        "text": ""
      }
    },
    {
      "match": {
        "regex": "^export\\s+AWS_DEFAULT_REGION=us-east-1$"
      },
      "mutateState": [
        {
          "op": "set",
          "path": "env.AWS_DEFAULT_REGION",
          "value": "us-east-1"
        },
        {
          "op": "set",
          "path": "region",
          "value": "us-east-1"
        }
      ],
      "response": {
        "text": ""
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-user\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "User": {
            "UserName": "messaging.ren.suzuki",
            "Arn": "arn:aws:iam::222222222222:user/messaging.ren.suzuki",
            "CreateDate": "2025-10-04T00:00:00+00:00"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+list-groups-for-user\\s+--user-name\\s+messaging\\\\.ren\\\\.suzuki\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "Groups": [
            {
              "GroupName": "sqsopen-operators",
              "Arn": "arn:aws:iam::222222222222:group/sqsopen-operators",
              "CreateDate": "2025-09-25T00:00:00+00:00"
            }
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-group\\s+--group-name\\s+sqsopen\\-operators\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "Group": {
            "GroupName": "sqsopen-operators",
            "Arn": "arn:aws:iam::222222222222:group/sqsopen-operators",
            "CreateDate": "2025-09-25T00:00:00+00:00"
          },
          "Users": [
            {
              "UserName": "messaging.ren.suzuki",
              "Arn": "arn:aws:iam::222222222222:user/messaging.ren.suzuki"
            }
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+list-attached-group-policies\\s+--group-name\\s+sqsopen\\-operators\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "AttachedPolicies": [
            {
              "PolicyName": "QueueReceivePublic",
              "PolicyArn": "arn:aws:iam::222222222222:policy/QueueReceivePublic"
            }
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-policy\\s+--policy-arn\\s+arn:aws:iam::222222222222:policy/QueueReceivePublic\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "Policy": {
            "PolicyName": "sqsopen-receive-public",
            "Arn": "arn:aws:iam::222222222222:policy/sqsopen-receive-public",
            "DefaultVersionId": "v1",
            "AttachmentCount": 1,
            "CreateDate": "2025-09-15T00:00:00+00:00",
            "UpdateDate": "2025-09-15T00:00:00+00:00"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-policy-version\\s+--policy-arn\\s+arn:aws:iam::222222222222:policy/QueueReceivePublic\\s+--version-id\\s+v1\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "PolicyVersion": {
            "VersionId": "v1",
            "IsDefaultVersion": true,
            "Document": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowReceivePublicQueue\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\"sqs:ListQueues\", \"sqs:ReceiveMessage\"],\n      \"Resource\": \"arn:aws:sqs:us-east-1:222222222222:sqsopen-notify-dev\"\n    }\n  ]\n}"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+sqs\\s+list-queues\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "sqs:ListQueues"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "QueueUrls": [
            "https://sqs.us-east-1.222222222222.amazonaws.com/222222222222/sqsopen-notify-dev",
            "https://sqs.us-east-1.222222222222.amazonaws.com/222222222222/sqsopen-ledger-dev"
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "UnknownOperation",
        "message": "You must specify a region. You can also configure your region by running 'aws configure'.",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws\\s+sqs\\s+get-queue-attributes\\s+--queue-url\\s+https://sqs\\.us-east-1\\.[0-9]{12}\\.amazonaws\\.com/[0-9]{12}/sqsopen\\-notify\\-dev\\s+--attribute-names\\s+All\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "sqs:GetQueueAttributes"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "Attributes": {
            "QueueArn": "arn:aws:sqs:us-east-1:222222222222:sqsopen-notify-dev",
            "ApproximateNumberOfMessages": "1",
            "VisibilityTimeout": "30",
            "Policy": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"PublicReceive\",\n      \"Effect\": \"Allow\",\n      \"Principal\": \"*\",\n      \"Action\": [\"sqs:ReceiveMessage\"],\n      \"Resource\": \"arn:aws:sqs:us-east-1:222222222222:sqsopen-notify-dev\"\n    }\n  ]\n}"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+sqs\\s+get-queue-attributes\\s+--queue-url\\s+https://sqs\\.us-east-1\\.[0-9]{12}\\.amazonaws\\.com/[0-9]{12}/sqsopen\\-ledger\\-dev\\s+--attribute-names\\s+All\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "sqs:GetQueueAttributes"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "Attributes": {
            "QueueArn": "arn:aws:sqs:us-east-1:222222222222:sqsopen-ledger-dev",
            "ApproximateNumberOfMessages": "1",
            "VisibilityTimeout": "30",
            "Policy": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"StrictOnlyAccount\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\"AWS\": \"arn:aws:iam::222222222222:root\"},\n      \"Action\": [\"sqs:ReceiveMessage\"],\n      \"Resource\": \"arn:aws:sqs:us-east-1:222222222222:sqsopen-ledger-dev\"\n    }\n  ]\n}"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+sqs\\s+receive-message\\s+--queue-url\\s+https://sqs\\.us-east-1\\.[0-9]{12}\\.amazonaws\\.com/[0-9]{12}/sqsopen\\-notify\\-dev\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "Messages": [
            {
              "MessageId": "11111111-2222-3333-4444-555555555555",
              "ReceiptHandle": "AQEBEXAMPLEhandle==",
              "MD5OfBody": "3f5d8c6f9b3d2a0e7a4c6f2c1d9e1234",
              "Body": "flag{sqs-public-policy-receive-123}"
            }
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+sqs\\s+receive-message\\s+--queue-url\\s+https://sqs\\.us-east-1\\.[0-9]{12}\\.amazonaws\\.com/[0-9]{12}/sqsopen\\-ledger\\-dev\\s*$"
      },
      "response": {
        "text": ""
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDenied) when calling the ReceiveMessage operation: Access Denied",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws\\s+ec2\\s+describe-instances\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "ec2:DescribeInstances"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "Reservations": [
            {
              "ReservationId": "r-0sqsopenops1",
              "OwnerId": "222222222222",
              "Instances": [
                {
                  "InstanceId": "i-0queueworkers12345",
                  "InstanceType": "t3.small",
                  "AvailabilityZone": "us-east-1a",
                  "State": {
                    "Name": "running"
                  },
                  "PrivateIpAddress": "10.0.12.45",
                  "Tags": [
                    {
                      "Key": "Name",
                      "Value": "sqsopen-workers"
                    },
                    {
                      "Key": "Service",
                      "Value": "sqs-demo"
                    }
                  ],
                  "SecurityGroups": [
                    {
                      "GroupName": "sqsopen-workers-sg",
                      "GroupId": "sg-0queue12345"
                    }
                  ],
                  "NetworkInterfaces": [
                    {
                      "NetworkInterfaceId": "eni-0123456789abcdef0",
                      "PrivateIpAddress": "10.0.12.45"
                    }
                  ]
                }
              ]
            }
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+ec2\\s+describe-security-groups\\s+--group-ids\\s+sg-0queue12345\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "ec2:DescribeSecurityGroups"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "SecurityGroups": [
            {
              "GroupId": "sg-0queue12345",
              "GroupName": "sqsopen-workers-sg",
              "Description": "Allow SQS pollers outbound",
              "VpcId": "vpc-0abc123queue",
              "IpPermissions": [
                {
                  "IpProtocol": "-1",
                  "IpRanges": [
                    {
                      "CidrIp": "0.0.0.0/0",
                      "Description": "Outbound internet for polling"
                    }
                  ]
                }
              ],
              "IpPermissionsEgress": [
                {
                  "IpProtocol": "-1",
                  "IpRanges": [
                    {
                      "CidrIp": "0.0.0.0/0",
                      "Description": "Allow responses"
                    }
                  ]
                }
              ],
              "Tags": [
                {
                  "Key": "Team",
                  "Value": "QueueOps"
                }
              ]
            }
          ]
        }
      }
    }
  ],
  "fallbackError": {
    "errorCode": "UnknownOperation",
    "message": "An error occurred. See 'aws --help'.",
    "exitCode": 255
  }
}
