{
  "meta": {
    "name": "05-hard",
    "version": "1.1",
    "defaultOutput": "text",
    "description": "Challenge 05."
  },
  "initialState": {
    "region": "",
    "env": {},
    "identities": [
      {
        "id": "userA",
        "accountId": "123456789012",
        "arn": "arn:aws:iam::123456789012:user/userA",
        "userName": "userA",
        "policies": [
          "kms:ListKeys",
          "kms:DescribeKey",
          "kms:GetKeyPolicy",
          "kms:ListAliases",
          "kms:ListResourceTags",
          "s3:ListBucket",
          "s3:GetObject",
          "iam:GetUser",
          "iam:ListUserPolicies",
          "iam:GetUserPolicy"
        ]
      }
    ],
    "activeIdentity": "userA",
    "custom": {
      "accountId": "123456789012",
      "region": "us-east-1",
      "keyId": "arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555",
      "bucket": "kms-lab-bucket",
      "cipherKey": "cipher.bin",
      "flag_b64": "ZmxhZ3trbXMtZGVjcnlwdC1wZXJtaXNzaXZlLXBvbGljeS0xMjN9",
      "flag": "flag{kms-decrypt-permissive-policy-123}",
      "hasCipher": false
    }
  },
  "commands": [
    {
      "match": { "equals": "aws sts get-caller-identity" },
      "response": {
        "render": "json",
        "json": {
          "UserId": "AIDAEXAMPLE",
          "Account": "123456789012",
          "Arn": "arn:aws:iam::123456789012:user/userA"
        }
      }
    },

    {
      "match": { "regex": "^aws\\s+configure\\s+set\\s+region\\s+us-east-1$" },
      "mutateState": [{ "op": "set", "path": "region", "value": "us-east-1" }],
      "response": { "text": "" }
    },
    {
      "match": { "regex": "^export\\s+AWS_DEFAULT_REGION=us-east-1$" },
      "mutateState": [
        { "op": "set", "path": "env.AWS_DEFAULT_REGION", "value": "us-east-1" },
        { "op": "set", "path": "region", "value": "us-east-1" }
      ],
      "response": { "text": "" }
    },
    {
      "match": { "regex": "^aws\\s+iam\\s+get-user\\s*$" },
      "requires": { "regionSet": true },
      "response": {
        "render": "json",
        "json": {
          "User": {
            "UserName": "userA",
            "Arn": "arn:aws:iam::123456789012:user/userA",
            "CreateDate": "2025-10-04T00:00:00+00:00"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+list-user-policies\\s+--user-name\\s+userA\\s*$"
      },
      "requires": { "regionSet": true },
      "response": {
        "render": "json",
        "json": {
          "PolicyNames": ["KMSDecryptNotes"]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-user-policy\\s+--user-name\\s+userA\\s+--policy-name\\s+KMSDecryptNotes\\s*$"
      },
      "requires": { "regionSet": true },
      "response": {
        "render": "json",
        "json": {
          "Policy": {
            "UserName": "userA",
            "PolicyName": "KMSDecryptNotes",
            "PolicyDocument": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"ReviewEncryptedArtifacts\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\"kms:ListKeys\", \"kms:DescribeKey\"],\n      \"Resource\": \"*\"\n    }\n  ]\n}"
          }
        }
      }
    },

    {
      "match": { "regex": "^aws\\s+kms\\s+list-keys\\s*$" },
      "requires": { "regionSet": true, "hasPoliciesAny": ["kms:ListKeys"] },
      "response": {
        "render": "json",
        "json": {
          "Keys": [
            {
              "KeyId": "arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555",
              "KeyArn": "arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555"
            }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "UnknownOperation",
        "message": "You must specify a region. You can also configure your region by running 'aws configure'.",
        "exitCode": 255
      }
    },
    {
      "match": { "regex": "^aws\\s+kms\\s+list-aliases\\s*$" },
      "requires": {
        "regionSet": true,
        "hasPoliciesAny": ["kms:ListAliases"]
      },
      "response": {
        "render": "json",
        "json": {
          "Aliases": [
            {
              "AliasName": "alias/prod-app-key",
              "AliasArn": "arn:aws:kms:us-east-1:123456789012:alias/prod-app-key",
              "TargetKeyId": "11111111-2222-3333-4444-555555555555"
            },
            {
              "AliasName": "alias/marketing-reports",
              "AliasArn": "arn:aws:kms:us-east-1:123456789012:alias/marketing-reports",
              "TargetKeyId": "99999999-aaaa-bbbb-cccc-dddddddddddd"
            }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDeniedException) when calling the ListAliases operation: Access denied",
        "exitCode": 255
      }
    },

    {
      "match": { "regex": "^aws\\s+kms\\s+describe-key\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s*$" },
      "requires": { "regionSet": true, "hasPoliciesAny": ["kms:DescribeKey"] },
      "response": {
        "render": "json",
        "json": {
          "KeyMetadata": {
            "AWSAccountId": "123456789012",
            "KeyId": "11111111-2222-3333-4444-555555555555",
            "Arn": "arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555",
            "CreationDate": "2025-10-04T00:00:00+00:00",
            "Enabled": true,
            "KeyState": "Enabled",
            "KeyUsage": "ENCRYPT_DECRYPT",
            "Description": "CTF demo key"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+describe-key\\s+--key-id\\s+alias/prod-app-key\\s*$"
      },
      "requires": { "regionSet": true, "hasPoliciesAny": ["kms:DescribeKey"] },
      "response": {
        "render": "json",
        "json": {
          "KeyMetadata": {
            "AWSAccountId": "123456789012",
            "KeyId": "11111111-2222-3333-4444-555555555555",
            "Arn": "arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555",
            "CreationDate": "2025-10-04T00:00:00+00:00",
            "Enabled": true,
            "KeyState": "Enabled",
            "KeyUsage": "ENCRYPT_DECRYPT",
            "Description": "CTF demo key"
          }
        }
      }
    },

    {
      "match": { "regex": "^aws\\s+kms\\s+get-key-policy\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s+--policy-name\\s+default\\s*$" },
      "requires": { "regionSet": true, "hasPoliciesAny": ["kms:GetKeyPolicy"] },
      "response": {
        "render": "json",
        "json": {
          "Policy": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowDecryptToEveryone\",\n      \"Effect\": \"Allow\",\n      \"Principal\": \"*\",\n      \"Action\": [\"kms:Decrypt\"],\n      \"Resource\": \"arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555\"\n    }\n  ]\n}"
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+list-resource-tags\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s*$"
      },
      "requires": {
        "regionSet": true,
        "hasPoliciesAny": ["kms:ListResourceTags"]
      },
      "response": {
        "render": "json",
        "json": {
          "Tags": [
            { "TagKey": "Environment", "TagValue": "production" },
            { "TagKey": "Owner", "TagValue": "data-platform" }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDeniedException) when calling the ListResourceTags operation: Access denied",
        "exitCode": 255
      }
    },

    {
      "match": { "regex": "^aws\\s+s3\\s+ls\\s+s3://kms-lab-bucket/?$" },
      "requires": { "regionSet": true, "hasPoliciesAny": ["s3:ListBucket"] },
      "response": {
        "text": "2025-10-04 00:00:00         128 cipher.bin\n"
      }
    },
    {
      "match": { "regex": "^aws\\s+s3\\s+cp\\s+s3://kms-lab-bucket/cipher\\.bin\\s+\\.\\s*$" },
      "requires": { "regionSet": true, "hasPoliciesAny": ["s3:GetObject"] },
      "mutateState": [
        { "op": "set", "path": "custom.hasCipher", "value": true }
      ],
      "response": {
        "text": "download: s3://kms-lab-bucket/cipher.bin to ./cipher.bin\n"
      }
    },

    {
      "match": { "regex": "^aws\\s+kms\\s+decrypt\\s+--ciphertext-blob\\s+fileb://cipher\\.bin\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s*$" },
      "requires": { "regionSet": true, "state": { "custom.hasCipher": true } },
      "response": {
        "render": "json",
        "json": {
          "KeyId": "arn:aws:kms:us-east-1:123456789012:key/11111111-2222-3333-4444-555555555555",
          "Plaintext": "ZmxhZ3trbXMtZGVjcnlwdC1wZXJtaXNzaXZlLXBvbGljeS0xMjN9"
        }
      }
    },

    {
      "match": { "regex": "^aws\\s+kms\\s+decrypt\\s+--ciphertext-blob\\s+fileb://cipher\\.bin\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s+--output\\s+text\\s+--query\\s+Plaintext\\s*$" },
      "requires": { "regionSet": true, "state": { "custom.hasCipher": true } },
      "response": {
        "text": "ZmxhZ3trbXMtZGVjcnlwdC1wZXJtaXNzaXZlLXBvbGljeS0xMjN9\n"
      }
    },

    {
      "match": { "regex": "^aws\\s+kms\\s+decrypt\\s+--ciphertext-blob\\s+fileb://cipher\\.bin(?:\\s+.*)?$" },
      "requires": { "regionSet": true },
      "response": { "text": "" },
      "errorOnFail": {
        "errorCode": "UnknownOperation",
        "message": "An error occurred (InvalidCiphertextException) when calling the Decrypt operation: Invalid Ciphertext",
        "exitCode": 255
      }
    }
  ],
  "fallbackError": {
    "errorCode": "UnknownOperation",
    "message": "An error occurred. See 'aws --help'.",
    "exitCode": 255
  }
}
