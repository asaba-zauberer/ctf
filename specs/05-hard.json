{
  "meta": {
    "name": "05-hard",
    "version": "1.1",
    "defaultOutput": "text",
    "description": "Challenge 05."
  },
  "initialState": {
    "region": "",
    "env": {},
    "identities": [
      {
        "id": "crypto.riku.aoyama",
        "accountId": "333333333333",
        "arn": "arn:aws:iam::333333333333:user/crypto.riku.aoyama",
        "userName": "crypto.riku.aoyama",
        "policies": [
          "kms:ListKeys",
          "kms:DescribeKey",
          "kms:GetKeyPolicy",
          "kms:ListAliases",
          "kms:ListResourceTags",
          "s3:ListBucket",
          "s3:GetObject",
          "iam:GetUser",
          "iam:ListUserPolicies",
          "iam:GetUserPolicy"
        ]
      }
    ],
    "activeIdentity": "crypto.riku.aoyama",
    "custom": {
      "accountId": "333333333333",
      "region": "us-east-1",
      "keyId": "arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211",
      "bucket": "kmsper-crypto-prod-202510-c4d2",
      "cipherKey": "cipher.bin",
      "flag_b64": "ZmxhZ3trbXMtZGVjcnlwdC1wZXJtaXNzaXZlLXBvbGljeS0xMjN9",
      "flag": "flag{kms-decrypt-permissive-policy-123}",
      "hasCipher": false
    }
  },
  "commands": [
    {
      "match": {
        "equals": "aws sts get-caller-identity"
      },
      "response": {
        "render": "json",
        "json": {
          "UserId": "AIDACTFKMSPER01",
          "Account": "333333333333",
          "Arn": "arn:aws:iam::333333333333:user/crypto.riku.aoyama"
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+configure\\s+set\\s+region\\s+us-east-1$"
      },
      "mutateState": [
        {
          "op": "set",
          "path": "region",
          "value": "us-east-1"
        }
      ],
      "response": {
        "text": ""
      }
    },
    {
      "match": {
        "regex": "^export\\s+AWS_DEFAULT_REGION=us-east-1$"
      },
      "mutateState": [
        {
          "op": "set",
          "path": "env.AWS_DEFAULT_REGION",
          "value": "us-east-1"
        },
        {
          "op": "set",
          "path": "region",
          "value": "us-east-1"
        }
      ],
      "response": {
        "text": ""
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-user\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "User": {
            "UserName": "crypto.riku.aoyama",
            "Arn": "arn:aws:iam::333333333333:user/crypto.riku.aoyama",
            "CreateDate": "2025-10-04T00:00:00+00:00"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+list-user-policies\\s+--user-name\\s+crypto\\\\.riku\\\\.aoyama\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "PolicyNames": [
            "kmsper-decrypt-notes"
          ]
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+iam\\s+get-user-policy\\s+--user-name\\s+crypto\\\\.riku\\\\.aoyama\\s+--policy-name\\s+kmsper-decrypt-notes\\s*$"
      },
      "response": {
        "render": "json",
        "json": {
          "Policy": {
            "UserName": "crypto.riku.aoyama",
            "PolicyName": "kmsper-decrypt-notes",
            "PolicyDocument": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"ReviewEncryptedArtifacts\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\"kms:ListKeys\", \"kms:DescribeKey\"],\n      \"Resource\": \"*\"\n    }\n  ]\n}"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+list-keys\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "kms:ListKeys"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "Keys": [
            {
              "KeyId": "arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211",
              "KeyArn": "arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211"
            }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "UnknownOperation",
        "message": "You must specify a region. You can also configure your region by running 'aws configure'.",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+list-aliases\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "kms:ListAliases"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "Aliases": [
            {
              "AliasName": "alias/kmsper-app-prod",
              "AliasArn": "arn:aws:kms:us-east-1:333333333333:alias/kmsper-app-prod",
              "TargetKeyId": "0f1e2d3c-4b5a-6978-8877-665544332211"
            },
            {
              "AliasName": "alias/kmsper-marketing",
              "AliasArn": "arn:aws:kms:us-east-1:333333333333:alias/kmsper-marketing",
              "TargetKeyId": "0f1e2d3c-4b5a-6978-8877-665544332211"
            }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDeniedException) when calling the ListAliases operation: Access denied",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+describe-key\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "kms:DescribeKey"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "KeyMetadata": {
            "AWSAccountId": "333333333333",
            "KeyId": "arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211",
            "Arn": "arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211",
            "CreationDate": "2025-10-04T00:00:00+00:00",
            "Enabled": true,
            "KeyState": "Enabled",
            "KeyUsage": "ENCRYPT_DECRYPT",
            "Description": "CTF demo key"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+describe-key\\s+--key-id\\s+alias\\/kmsper\\-app\\-prod\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "kms:DescribeKey"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "KeyMetadata": {
            "AWSAccountId": "333333333333",
            "KeyId": "arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211",
            "Arn": "arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211",
            "CreationDate": "2025-10-04T00:00:00+00:00",
            "Enabled": true,
            "KeyState": "Enabled",
            "KeyUsage": "ENCRYPT_DECRYPT",
            "Description": "CTF demo key"
          }
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+get-key-policy\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s+--policy-name\\s+default\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "kms:GetKeyPolicy"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "Policy": "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AllowDecryptToEveryone\",\n      \"Effect\": \"Allow\",\n      \"Principal\": \"*\",\n      \"Action\": [\"kms:Decrypt\"],\n      \"Resource\": \"arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211\"\n    }\n  ]\n}"
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+list-resource-tags\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "kms:ListResourceTags"
        ]
      },
      "response": {
        "render": "json",
        "json": {
          "Tags": [
            {
              "TagKey": "Environment",
              "TagValue": "production"
            },
            {
              "TagKey": "Owner",
              "TagValue": "data-platform"
            }
          ]
        }
      },
      "errorOnFail": {
        "errorCode": "AccessDenied",
        "message": "An error occurred (AccessDeniedException) when calling the ListResourceTags operation: Access denied",
        "exitCode": 255
      }
    },
    {
      "match": {
        "regex": "^aws\\s+s3\\s+ls\\s+s3://kmsper\\-crypto\\-prod\\-202510\\-c4d2/?$"
      },
      "requires": {
        "hasPoliciesAny": [
          "s3:ListBucket"
        ]
      },
      "response": {
        "text": "2025-10-04 00:00:00         128 cipher.bin\n"
      }
    },
    {
      "match": {
        "regex": "^aws\\s+s3\\s+cp\\s+s3://kmsper\\-crypto\\-prod\\-202510\\-c4d2/cipher\\.bin\\s+\\.\\s*$"
      },
      "requires": {
        "hasPoliciesAny": [
          "s3:GetObject"
        ]
      },
      "mutateState": [
        {
          "op": "set",
          "path": "custom.hasCipher",
          "value": true
        }
      ],
      "response": {
        "text": "download: s3://kmsper-crypto-prod-202510-c4d2/cipher.bin to ./cipher.bin\n"
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+decrypt\\s+--ciphertext-blob\\s+fileb://cipher\\.bin\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s*$"
      },
      "requires": {
        "state": {
          "custom.hasCipher": true
        }
      },
      "response": {
        "render": "json",
        "json": {
          "KeyId": "arn:aws:kms:us-east-1:333333333333:key/0f1e2d3c-4b5a-6978-8877-665544332211",
          "Plaintext": "ZmxhZ3trbXMtZGVjcnlwdC1wZXJtaXNzaXZlLXBvbGljeS0xMjN9"
        }
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+decrypt\\s+--ciphertext-blob\\s+fileb://cipher\\.bin\\s+--key-id\\s+arn:aws:kms:us-east-1:[0-9]{12}:key/[0-9a-f-]{36}\\s+--output\\s+text\\s+--query\\s+Plaintext\\s*$"
      },
      "requires": {
        "state": {
          "custom.hasCipher": true
        }
      },
      "response": {
        "text": "ZmxhZ3trbXMtZGVjcnlwdC1wZXJtaXNzaXZlLXBvbGljeS0xMjN9\n"
      }
    },
    {
      "match": {
        "regex": "^aws\\s+kms\\s+decrypt\\s+--ciphertext-blob\\s+fileb://cipher\\.bin(?:\\s+.*)?$"
      },
      "response": {
        "text": ""
      },
      "errorOnFail": {
        "errorCode": "UnknownOperation",
        "message": "An error occurred (InvalidCiphertextException) when calling the Decrypt operation: Invalid Ciphertext",
        "exitCode": 255
      }
    }
  ],
  "fallbackError": {
    "errorCode": "UnknownOperation",
    "message": "An error occurred. See 'aws --help'.",
    "exitCode": 255
  }
}
